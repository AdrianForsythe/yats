{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Gantt Chart - YATS{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-project-diagram"></i> Project Timeline</h1>
        <p>Interactive Gantt chart for project management and task scheduling</p>
    </div>

    <div class="gantt-container">
        <div id="gantt_here" style='width:100%; height:600px;'></div>
    </div>
</div>

<script src="{% static "dashboard/gantt/dhtmlxgantt.js" %}" type="text/javascript"></script>
<link rel="stylesheet" href="{% static "dashboard/gantt/dhtmlxgantt.css" %}" />

<script>
gantt.config.date_format = "%Y-%m-%d %H:%i";
gantt.config.order_branch = "marker";
gantt.config.order_branch_free = true;
gantt.config.open_tree_initially = true;

// Customize task classes based on readonly status
gantt.templates.task_class = function(start, end, task) {
    if (task.readonly) {
        return "gantt_readonly_task";
    }
    return "";
};

// Customize grid row classes
gantt.templates.grid_row_class = function(start, end, task) {
    if (task.readonly) {
        return "gantt_readonly_row";
    }
    return "";
};

gantt.attachEvent("onLoadEnd", function() {
    gantt.batchUpdate(function() {
        gantt.sort("sort_order", false)
    })
});

gantt.attachEvent("onRowDragEnd", function(id, target) {
    var task = gantt.getTask(id);
    // Prevent dragging readonly tasks
    if (task.readonly) {
        return false;
    }
    //update the order of tasks
    gantt.batchUpdate(function() {
        gantt.eachTask(function(task) {
            task.sort_order = task.$local_index + 1;
            gantt.updateTask(task.id)
        })
    })
});

gantt.attachEvent("onBeforeTaskAdd", function(id, task) {
    task.sort_order = task.$local_index + 1;
    return true;
});

// Prevent editing readonly tasks
gantt.attachEvent("onBeforeTaskChanged", function(id, mode, task) {
    if (task.readonly) {
        gantt.message({
            type: "error",
            text: "This task is read-only and cannot be modified"
        });
        return false;
    }
    return true;
});

// Prevent deleting readonly tasks
gantt.attachEvent("onBeforeTaskDelete", function(id, task) {
    if (task.readonly) {
        gantt.message({
            type: "error",
            text: "This task is read-only and cannot be deleted"
        });
        return false;
    }
    return true;
});

// Prevent dragging readonly tasks
gantt.attachEvent("onBeforeTaskDrag", function(id, mode, e) {
    var task = gantt.getTask(id);
    if (task.readonly) {
        return false;
    }
    return true;
});

// Prevent opening lightbox for readonly tasks
gantt.attachEvent("onBeforeLightbox", function(id) {
    var task = gantt.getTask(id);
    if (task.readonly) {
        gantt.message({
            type: "info",
            text: "This is a read-only task from MinKNOW"
        });
        return false;
    }
    return true;
});

gantt.init("gantt_here");
gantt.load("/dashboard/gantt/data/", "json");

var dp = new gantt.dataProcessor("/dashboard/gantt/data/");
dp.init(gantt);
dp.setTransactionMode("REST");
</script>

<style>
.gantt-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    padding: 20px;
    margin-top: 20px;
}

.dashboard-header {
    margin-bottom: 20px;
}

.dashboard-header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.dashboard-header p {
    color: #7f8c8d;
    font-size: 16px;
}

/* Readonly task styles */
.gantt_readonly_task {
    opacity: 0.85;
    cursor: not-allowed !important;
}

.gantt_readonly_task .gantt_task_content {
    cursor: not-allowed !important;
}

.gantt_readonly_row {
    background-color: #f9f9f9;
    font-style: italic;
}

.gantt_readonly_row .gantt_cell {
    color: #666;
}

/* Add a lock icon indicator for readonly tasks */
.gantt_readonly_task::after {
    content: "ðŸ”’";
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 12px;
    opacity: 0.6;
}
</style>
{% endblock %}
