{% extends "dashboard/base.html" %}
{% load static %}

{% block title %}Sequencing Analytics - YATS{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1><i class="fas fa-dna"></i> Sequencing Analytics</h1>
        <p>Lab management dashboard based on Monday List data</p>
    </div>

    {% if error %}
    <div class="alert alert-warning">
        <i class="fas fa-exclamation-triangle"></i> {{ error }}
    </div>
    {% endif %}

    <!-- Key Metrics -->
    <div class="metrics-grid">
        <div class="metric-card">
            <h3>Total Samples</h3>
            <div class="metric-value">{{ total_samples }}</div>
        </div>
        
        <div class="metric-card">
            <h3>Recent Samples (30 days)</h3>
            <div class="metric-value">{{ recent_samples }}</div>
        </div>
        
        <div class="metric-card">
            <h3>Active Users</h3>
            <div class="metric-value">{{ user_counts|length }}</div>
        </div>
        
        <div class="metric-card">
            <h3>Applications</h3>
            <div class="metric-value">{{ application_counts|length }}</div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
        <div class="chart-container">
            <h3><i class="fas fa-chart-pie"></i> Samples by Status</h3>
            <canvas id="statusChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-chart-bar"></i> Top Applications</h3>
            <canvas id="applicationChart" width="400" height="200"></canvas>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-users"></i> Top Users</h3>
            <div class="user-list">
                {% for user, count in user_counts.items %}
                <div class="user-item">
                    <span class="user-name">{{ user }}</span>
                    <span class="user-count">{{ count }} samples</span>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="chart-container">
            <h3><i class="fas fa-chart-line"></i> Status Distribution</h3>
            <div class="status-breakdown">
                {% for status, count in status_counts.items %}
                <div class="status-item">
                    <div class="status-info">
                        <span class="status-name">{{ status }}</span>
                        <span class="status-count">{{ count }} samples</span>
                    </div>
                    <div class="status-bar">
                        <div class="status-fill" style="width: {% widthratio count total_samples 100 %}%"></div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Monday List Data Table -->
    <div class="data-table-container">
        <h2><i class="fas fa-table"></i> Monday List Data</h2>
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Application</th>
                        <th>Machine Read</th>
                        <th>Paired End</th>
                        <th>User</th>
                        <th>N Samples</th>
                        <th>Pool Size</th>
                        <th>Date Accepted</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in monday_list_data %}
                    <tr>
                        <td><span class="status-badge status-{{ row.0|lower|slugify }}">{{ row.0 }}</span></td>
                        <td>{{ row.1 }}</td>
                        <td>{{ row.2 }}</td>
                        <td>{{ row.3 }}</td>
                        <td>{{ row.4 }}</td>
                        <td>{{ row.5 }}</td>
                        <td>{{ row.6 }}</td>
                        <td>{{ row.7 }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let statusChart, applicationChart;

document.addEventListener('DOMContentLoaded', function() {
    initializeCharts();
});

function initializeCharts() {
    // Status Chart
    const statusCtx = document.getElementById('statusChart').getContext('2d');
    const statusData = {{ status_counts|safe }};
    statusChart = new Chart(statusCtx, {
        type: 'doughnut',
        data: {
            labels: Object.keys(statusData),
            datasets: [{
                data: Object.values(statusData),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });

    // Application Chart
    const appCtx = document.getElementById('applicationChart').getContext('2d');
    const appData = {{ application_counts|safe }};
    const sortedApps = Object.entries(appData)
        .sort(([,a], [,b]) => b - a)
        .slice(0, 10);
    
    applicationChart = new Chart(appCtx, {
        type: 'bar',
        data: {
            labels: sortedApps.map(([name]) => name),
            datasets: [{
                label: 'Samples',
                data: sortedApps.map(([,count]) => count),
                backgroundColor: '#36A2EB',
                borderColor: '#36A2EB',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}
</script>

<style>
.status-badge {
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
}

.status-received { background-color: #e3f2fd; color: #1976d2; }
.status-accepted { background-color: #e8f5e8; color: #388e3c; }
.status-library-prepared { background-color: #fff3e0; color: #f57c00; }
.status-solexa-assigned { background-color: #f3e5f5; color: #7b1fa2; }
.status-data-analysed { background-color: #e0f2f1; color: #00695c; }
.status-library { background-color: #fff3e0; color: #f57c00; }
.status-data { background-color: #e0f2f1; color: #00695c; }

.status-item {
    margin-bottom: 15px;
}

.status-info {
    display: flex;
    justify-content: space-between;
    margin-bottom: 5px;
}

.status-name {
    font-weight: 500;
    color: #333;
}

.status-count {
    color: #666;
    font-size: 0.9em;
}

.status-bar {
    height: 8px;
    background-color: #f0f0f0;
    border-radius: 4px;
    overflow: hidden;
}

.status-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.3s ease;
}

.user-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 0;
    border-bottom: 1px solid #eee;
}

.user-name {
    font-weight: 500;
    color: #333;
}

.user-count {
    background: #667eea;
    color: white;
    padding: 2px 8px;
    border-radius: 12px;
    font-size: 0.8em;
    font-weight: bold;
}

.data-table-container {
    background: white;
    padding: 25px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-top: 30px;
}

.table-responsive {
    overflow-x: auto;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #333;
    border-top: none;
}

.table td {
    vertical-align: middle;
}

.status-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 0.8em;
    font-weight: bold;
    text-transform: uppercase;
}
</style>
{% endblock %}
